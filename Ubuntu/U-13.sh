cat << EOF
===== [U-13] Check SUID, SGID, settings file               =====
=====                  Chaking...........               =====
EOF
echo "--------------------------------------------------------------------------" >> $target
echo "                        U-13   SUID, SGID, ì„¤ì • íŒŒì¼ì ê²€                        " >> $target
echo "--------------------------------------------------------------------------" >> $target
echo "++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++" >> $target
echo "ì ê²€ëª©ì  : ë¶ˆí•„ìš”í•œ SUID, SGID ì„¤ì • ì œê±°ë¡œ ì•…ì˜ì ì¸ ì‚¬ìš©ìì˜ ê¶Œí•œìƒìŠ¹ì„ ë°©ì§€í•˜ê¸° ìœ„í•¨" >> $target
echo "ë³´ì•ˆìœ„í˜‘ : SUID, SGID íŒŒì¼ì˜ ì ‘ê·¼ê¶Œí•œì´ ì ì ˆí•˜ì§€ ì•Šì„ ê²½ìš° SUID, SGID ì„¤ì •ëœ íŒŒì¼ë¡œ íŠ¹ì • ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ root ê¶Œí•œ íšë“ ê°€ëŠ¥í•¨" >> $target
echo "+íŒë‹¨ê¸°ì¤€ ì–‘í˜¸ ğŸ”˜: ì£¼ìš” ì‹¤í–‰íŒŒì¼ì˜ ê¶Œí•œì— SUIDì™€ SGIDì— ëŒ€í•œ ì„¤ì •ì´ ë¶€ì—¬ë˜ì–´ ìˆì§€ ì•Šì€ ê²½ìš°" >> $target
echo "+íŒë‹¨ê¸°ì¤€ ì·¨ì•½ ğŸš«: ì£¼ìš” ì‹¤í–‰íŒŒì¼ì˜ ê¶Œí•œì— SUIDì™€ SGIDì— ëŒ€í•œ ì„¤ì •ì´ ë¶€ì—¬ë˜ì–´ ìˆëŠ” ê²½ìš°" >> $target
echo "++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++" >> $target
echo "" >> $target
echo "-------------" >> $result
echo "U-13 ì ê²€ ê²°ê³¼" >> $result
u13=0
u13_Files_Directory_Management=0
u13_safe_check=0

u13_default_sugid_files=(
    "/usr/lib/x86_64-linux-gnu/utempter/utempter"
    "/usr/lib/xorg/Xorg.wrap"
    "/usr/lib/snapd/snap-confine"
    "/usr/lib/openssh/ssh-keysign"
    "/usr/lib/dbus-1.0/dbus-daemon-launch-helper"
    "/usr/libexec/camel-lock-helper-1.2"
    "/usr/libexec/polkit-agent-helper-1"
    "/usr/sbin/unix_chkpwd"
    "/usr/sbin/pppd"
    "/usr/sbin/pam_extrausers_chkpwd"
    "/usr/bin/newgrp"
    "/usr/bin/chsh"
    "/usr/bin/fusermount3"
    "/usr/bin/pkexec"
    "/usr/bin/chage"
    "/usr/bin/vmware-user-suid-wrapper"
    "/usr/bin/chfn"
    "/usr/bin/crontab"
    "/usr/bin/expiry"
    "/usr/bin/gpasswd"
    "/usr/bin/su"
    "/usr/bin/mount"
    "/usr/bin/sudo"
    "/usr/bin/umount"
    "/usr/bin/ssh-agent"
    "/usr/bin/passwd"
)

u13_check_sugid_files=(
    "/sbin/dump" 
    "/sbin/restore" 
    "/sbin/unix_chkpwd" 
    "/usr/bin/at" 
    "/usr/bin/lpq" 
    "/usr/bin/lpq-lpd" 
    "/usr/bin/lpr" 
    "/usr/bin/lpr-lpd" 
    "/usr/bin/lprm" 
    "/usr/bin/lprm-lpd" 
    "/usr/bin/newgrp" 
    "/usr/sbin/lpc" 
    "/usr/sbin/lpc-lpd" 
    "/usr/sbin/traceroute"
)

echo -e "${RED}Ubunt ì‹œìŠ¤í…œì˜ ê¸°ë³¸ì ìœ¼ë¡œ ì„¤ì •ëœ SUID, SGID íŒŒì¼ì„ ì œì™¸í•œ ì˜ëª»ëœ SUID, SGID ì„¤ì • íŒŒì¼ë“¤ì„ í™•ì¸í•©ë‹ˆë‹¤.${NC}"  >> $target
# ê²°ê³¼ë¥¼ ì €ì¥í•  ë°°ì—´
u13_questionable_files=()

# `find` ëª…ë ¹ì–´ì˜ ê²°ê³¼ë¥¼ ë°°ì—´ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
mapfile -t u13_find_results < <(find / -xdev -user root -type f \( -perm -04000 -o -perm -02000 \) 2>/dev/null)

# ê° íŒŒì¼ì— ëŒ€í•´ ì œì™¸í•  ëª©ë¡ê³¼ ë¹„êµí•˜ì—¬ ì¤‘ë³µì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
for u13_find_result in "${u13_find_results[@]}"; do
    u13_exclude=0
    for u13_exclude_file in "${u13_default_sugid_files[@]}"; do
        if [[ "$u13_find_result" == "$u13_exclude_file" ]]; then
            u13_exclude=1
            break
        fi
    done
    
    # ì¤‘ë³µë˜ì§€ ì•Šê±°ë‚˜ ì œì™¸ ëª©ë¡ì— í¬í•¨ë˜ì§€ ì•ŠëŠ” ê²½ìš° ë°°ì—´ì— ì¶”ê°€
    if [[ $u13_exclude -eq 0 ]]; then
        # ë°°ì—´ì— ì¶”ê°€í•˜ê¸° ì „ì— ì¤‘ë³µ í™•ì¸
        if [[ ! " ${u13_questionable_files[@]} " =~ " ${u13_find_result} " ]]; then
            u13_questionable_files+=("$u13_find_result")
        fi
    fi
done

if [[ ${#u13_questionable_files[@]} -gt 0 ]]; then
    u13_safe_check=$((u13_safe_check+1))
    echo "ë‹¤ìŒ íŒŒì¼ë“¤ì€ ì œì™¸ ëª©ë¡ì— ì—†ê±°ë‚˜ ì¤‘ë³µë˜ì§€ ì•Šìœ¼ë©°, ì˜ì‹¬ìŠ¤ëŸ¬ìš´ SUID, SGIDê°€ ì„¤ì •ë­ì–´ ìˆìŠµë‹ˆë‹¤." >> $target
    for u13_questionable_file in "${u13_questionable_files[@]}"; do
        echo "$u13_questionable_file" >> $target
    done
else
    echo "ì œì™¸ ëª©ë¡ì— í¬í•¨ë˜ì§€ ì•ŠëŠ” íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤." >> $target
fi

echo -e "${RED}Check-List ê¸°ë°˜ì˜ ë¶ˆí•„ìš”í•œ SUID/SGID ì„¤ì • íŒŒì¼ ëª©ë¡ì„ ì ê²€í•©ë‹ˆë‹¤.${NC}" >> $target
for u13_check_sugid_file in "${u13_check_sugid_files[@]}";do
    u13_chekc_perm=$(stat -c "%A" "$u13_check_sugid_file" 2> /dev/null )
    if [[ $u13_chekc_perm == *s* || $u13_chekc_perm == *S* ]];then
        echo "$u13_check_sugid_file íŒŒì¼ì— ë¶ˆí•„ìš”í•œ SUID/SGID ê°€ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤." >> $target
        u13_safe_check=$((u13_safe_check+1))
    fi
done

if [[ $u13_safe_check -ge 1 ]];then
    u13=$((u13+1))
    echo "ì ê²€ ê²°ê³¼ : ì·¨ì•½" >> $result
else
    echo "ì ê²€ ê²°ê³¼ : ì–‘í˜¸" >> $result
fi
if [[ $u13 -ge 1 ]];then
    High=$((High+1))
    Files_Directory_Management=$((Files_Directory_Management+1))
    u13_Files_Directory_Management=1
fi