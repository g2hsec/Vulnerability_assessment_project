cat << EOF
===== [U-23] Disabling a Service Vulnerable to DoS Attacks              =====
=====                  Chaking...........               =====
EOF
echo "--------------------------------------------------------------------------" >> $target
echo "                        U-23 DoS ê³µê²©ì— ì·¨ì•½í•œ ì„œë¹„ìŠ¤ ë¹„í™œì„±í™”               " >> $target
echo "--------------------------------------------------------------------------" >> $target
echo "++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++" >> $target
echo "+ì ê²€ëª©ì  : ì‹œìŠ¤í…œ ë³´ì•ˆì„±ì„ ë†’ì´ê¸° ìœ„í•´ ì·¨ì•½ì ì´ ë§ì´ ë°œí‘œëœ echo, discard, daytime, chargen, ntp, snmp ë“± ì„œë¹„ìŠ¤ë¥¼ ì¤‘ì§€í•¨" >> $target
echo "+ë³´ì•ˆìœ„í˜‘ :  í•´ë‹¹ ì„œë¹„ìŠ¤ê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ” ê²½ìš° ì‹œìŠ¤í…œ ì •ë³´ ìœ ì¶œ ë° DoS(ì„œë¹„ìŠ¤ ê±°ë¶€ ê³µê²©)ì˜ ëŒ€ìƒì´ ë  ìˆ˜ ìˆìŒ" >> $target
echo "+íŒë‹¨ê¸°ì¤€ ì–‘í˜¸ ğŸ”˜: ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” DoS ê³µê²©ì— ì·¨ì•½í•œ ì„œë¹„ìŠ¤ê°€ ë¹„í™œì„±í™” ëœ ê²½ìš°" >> $target
echo "+íŒë‹¨ê¸°ì¤€ ì·¨ì•½ ğŸš«: ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” DoS ê³µê²©ì— ì·¨ì•½í•œ ì„œë¹„ìŠ¤ê°€ í™œì„±í™” ëœ ê²½ìš°" >> $target
echo "++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++" >> $target
echo "" >> $target
# ntp ì„œë¹„ìŠ¤ëŠ” ë³´í†µ ë³„ë„ì˜ ë°ëª¬(ntpd, chronyd)ìœ¼ë¡œ ê´€ë¦¬ë¨ (inetd.confì—ëŠ” ì—†ìŒ)
# snmp ì„œë¹„ìŠ¤ëŠ” ë³„ë„ì˜ ë°ëª¬(snmpd)ìœ¼ë¡œ ê´€ë¦¬ë¨ (inetd.confì—ëŠ” ì—†ìŒ)
# dns ì„œë¹„ìŠ¤ëŠ” ë³´í†µ ë³„ë„ì˜ ë°ëª¬(named, systemd-resolved)ìœ¼ë¡œ ê´€ë¦¬ë¨ (inetd.confì—ëŠ” ì—†ìŒ)
# smtp ì„œë¹„ìŠ¤ëŠ” ë³´í†µ ë³„ë„ì˜ ë°ëª¬(postfix, exim, sendmail)ìœ¼ë¡œ ê´€ë¦¬ë¨ (inetd.confì—ëŠ” ì—†ìŒ)

# ntpd ë˜ëŠ” chronydëŠ” /etc/xinetd.d íŒŒì¼ì´ ì•„ë‹Œ ë³„ë„ì˜ ë°ëª¬ìœ¼ë¡œ ê´€ë¦¬ë˜ë©°, /etc/xinetd.dì—ëŠ” í•­ëª©ì´ ì—†ìŒ systemctlë¡œ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ì„¤ì •í•  ìˆ˜ ìˆìŒ
# snmp ëŠ” /etc/xinetd.d íŒŒì¼ì´ ì•„ë‹Œ ë³„ë„ì˜ ë°ëª¬ìœ¼ë¡œ ê´€ë¦¬ë˜ë©°, /etc/xinetd.dì—ëŠ” í•­ëª©ì´ ì—†ìŒ systemctlë¡œ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ì„¤ì •í•  ìˆ˜ ìˆìŒ
# named (BIND) ë˜ëŠ” systemd-resolvedëŠ” /etc/xinetd.d íŒŒì¼ì´ ì•„ë‹Œ ë³„ë„ì˜ ë°ëª¬ìœ¼ë¡œ ê´€ë¦¬ë˜ë©°, /etc/xinetd.dì—ëŠ” í•­ëª©ì´ ì—†ìŒ. ëŒ€ì‹  systemctlë¡œ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ì„¤ì •í•  ìˆ˜ ìˆìŒ
# (smtp) postfix, exim, ë˜ëŠ” sendmailì€ /etc/xinetd.d íŒŒì¼ì´ ì•„ë‹Œ ë³„ë„ì˜ ë°ëª¬ìœ¼ë¡œ ê´€ë¦¬ë˜ë©°, /etc/xinetd.dì—ëŠ” í•­ëª©ì´ ì—†ìŒ. ëŒ€ì‹  systemctlë¡œ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ì„¤ì •í•  ìˆ˜ ìˆìŒ:
u23=0
u23_Service_Management=0
u23_safe_check=0
u23_service_checks=("echo" "discard" "daytime" "chargen" "ntp" "snmp" "tcpmux" "time" "smtp" "domain")
u23_service_ports=("7" "9" "13" "19" "123" "161" "68" "37" "25" "53")
u23_inetd_checks=("echo" "discard" "daytime" "chargen" "tcpmux" "time")
u23_xinetd_checks=("echo" "discard" "daytime" "chargen" "tcpmux" "time")
u23_systemctl_checks=("ntpd" "chronyd" "snmpd" "named" "systemd-resolved" "postfix" "exim" "sendmail")
u23_length=${#u23_service_checks[@]}
# systemctl ì„œë¹„ìŠ¤ ì²´í¬
for u23_systemctl_check in "${u23_systemctl_checks[@]}"; do
    if systemctl is-active --quiet "$u23_systemctl_check"; then
        echo "í˜„ì¬ ì‹œìŠ¤í…œì— $u23_systemctl_check ì„œë¹„ìŠ¤ê°€ í™œì„±í™” ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë¶ˆí•„ìš”í•œ ê²½ìš° ë¹„í™œì„±í™”ê°€ ì´ë£¨ì–´ì ¸ì•¼ í•©ë‹ˆë‹¤." >> $target
        u23_safe_check=$((u23_safe_check+1))
    else
        echo "í˜„ì¬ ì‹œìŠ¤í…œì— $u23_systemctl_check ì„œë¹„ìŠ¤ê°€ ë¹„í™œì„±í™” ë˜ì–´ ìˆìŠµë‹ˆë‹¤." >> $target
    fi
done

# ë„¤íŠ¸ì›Œí¬ í¬íŠ¸ ì²´í¬
u23_netstat_ports=$(netstat -tuln | awk '{print $4}' | awk -F':' '{print $2}')

for ((i=0; i<$u23_length; i++)); do
    u23_port=${u23_service_ports[$i]}
    u23_service=${u23_service_checks[$i]}
    
    if echo "$u23_netstat_ports" | grep -qE "^$u23_port$"; then
        echo "$u23_service ì„œë¹„ìŠ¤ê°€ $u23_port ë²ˆ í¬íŠ¸ë²ˆí˜¸ë¡œ ì„œë¹„ìŠ¤ê°€ ë™ì‘ì¤‘ì…ë‹ˆë‹¤." >> $target
    else
        u23_newport=$(grep -wE "^$u23_service\s+" /etc/services | awk '{print $2}' | awk -F'/' '{print $1}' | head -n 1)
        if [ -n "$u23_newport" ]; then
            echo "$u23_service ì„œë¹„ìŠ¤ê°€ $u23_newport í¬íŠ¸ë²ˆí˜¸ë¡œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤." >> $target
            if echo "$u23_netstat_ports" | grep -qE "^$u23_newport$"; then
                echo "$u23_service ì„œë¹„ìŠ¤ê°€ $u23_newport í¬íŠ¸ë²ˆí˜¸ë¡œ ì„œë¹„ìŠ¤ê°€ ë™ì‘ì¤‘ì…ë‹ˆë‹¤." >> $target
                u23_safe_check=$((u23_safe_check+1))
            else
                echo "$u23_service ì„œë¹„ìŠ¤ê°€ $u23_newport í¬íŠ¸ë²ˆí˜¸ë¡œ ë™ì‘ì¤‘ì¸ ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤." >> $target
            fi
        else
            echo "$u23_service ì„œë¹„ìŠ¤ê°€ /etc/services íŒŒì¼ì— ì •ì˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤." >> $target
        fi
    fi        
done

# inetd ì„œë¹„ìŠ¤ ì²´í¬
if [ -f "/etc/inetd.conf" ]; then
    for u23_inetd_check in "${u23_inetd_checks[@]}"; do
        if grep -qiwE "^\s*$u23_inetd_check" /etc/inetd.conf; then
            echo "/etc/inetd.conf íŒŒì¼ì—ì„œ $u23_inetd_check ì„œë¹„ìŠ¤ê°€ í™œì„±í™” ë˜ì–´ ìˆìŠµë‹ˆë‹¤." >> $target
            u23_safe_check=$((u23_safe_check+1))
        else
            echo "/etc/inetd.conf íŒŒì¼ì—ì„œ $u23_inetd_check ì„œë¹„ìŠ¤ê°€ ë¹„í™œì„±í™” ë˜ì–´ ìˆìŠµë‹ˆë‹¤." >> $target
        fi
    done
else
    echo "/etc/inetd.conf íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." >> $target
fi

# xinetd ì„œë¹„ìŠ¤ ì²´í¬
if [ -d "/etc/xinetd.d" ]; then
    for u23_xinetd_check in "${u23_xinetd_checks[@]}"; do
        if [ -f "/etc/xinetd.d/$u23_xinetd_check" ]; then
            u23_xinetd_conf=$(grep -iE "\s*disable" "/etc/xinetd.d/$u23_xinetd_check" | grep -v "^#" | awk '{print $3}' | head -n 1)
            if [[ "$u23_xinetd_conf" == "no" ]]; then
                echo "/etc/xinetd.d/$u23_xinetd_check íŒŒì¼ë‚´ì— $u23_xinetd_check í•­ëª©ì´ í™œì„±í™” ë˜ì–´ ìˆìŠµë‹ˆë‹¤." >> $target
                u23_safe_check=$((u23_safe_check+1))
            else
                echo "/etc/xinetd.d/$u23_xinetd_check íŒŒì¼ë‚´ì— $u23_xinetd_check í•­ëª©ì´ ë¹„í™œì„±í™” ë˜ì–´ ìˆìŠµë‹ˆë‹¤." >> $target
            fi
        else
            echo "/etc/xinetd.d/$u23_xinetd_check íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." >> $target
        fi
    done
else
    echo "/etc/xinetd.d ë””ë ‰í„°ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." >> $target
fi

if [[ $u23_safe_check -ge 1 ]];then
    u23=$((u23+1))
    echo "ì ê²€ ê²°ê³¼ : ì·¨ì•½" >> $result
else
    echo "ì ê²€ ê²°ê³¼ : ì–‘í˜¸" >> $result
fi
if [[ $u23 -ge 1 ]];then
    High=$((High+1))
    Service_Management=$((Service_Management+1))
    u23_Service_Management=1
fi