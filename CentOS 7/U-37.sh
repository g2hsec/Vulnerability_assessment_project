cat << EOF
===== [U-37] Do not access the web service parent directory              =====
=====                  Chaking...........               =====
EOF
echo "--------------------------------------------------------------------------" >> $target
echo "                        U-37 ì›¹ì„œë¹„ìŠ¤ ìƒìœ„ ë””ë ‰í† ë¦¬ ì ‘ê·¼ ê¸ˆì§€              " >> $target
echo "--------------------------------------------------------------------------" >> $target
echo "++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++" >> $target
echo "+ì ê²€ëª©ì  : ìƒìœ„ ê²½ë¡œ ì´ë™ ëª…ë ¹ìœ¼ë¡œ ë¹„ì¸ê°€ìžì˜ íŠ¹ì • ë””ë ‰í„°ë¦¬ì— ëŒ€í•œ ì ‘ê·¼ ë° ì—´ëžŒì„ ì œí•œí•˜ì—¬ ì¤‘ìš” íŒŒì¼ ë° ë°ì´í„° ë³´í˜¸ë¥¼ ëª©ì ìœ¼ë¡œ í•¨" >> $target
echo "+ë³´ì•ˆìœ„í˜‘ : ìƒìœ„ ê²½ë¡œë¡œ ì´ë™í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•  ê²½ìš° ì ‘ê·¼í•˜ê³ ìž í•˜ëŠ” ë””ë ‰í„°ë¦¬ì˜ í•˜ìœ„ ê²½ë¡œì— ì ‘ì†í•˜ì—¬ ìƒìœ„ê²½ë¡œë¡œ ì´ë™í•¨ìœ¼ë¡œì¨ ì•…ì˜ì ì¸ ëª©ì ì„ ê°€ì§„ ì‚¬ìš©ìžì˜ ì ‘ê·¼ì´ ê°€ëŠ¥í•¨" >> $target
echo "+íŒë‹¨ê¸°ì¤€ ì–‘í˜¸ ðŸ”˜: ìƒìœ„ ë””ë ‰í„°ë¦¬ì— ì´ë™ì œí•œì„ ì„¤ì •í•œ ê²½ìš°" >> $target
echo "+íŒë‹¨ê¸°ì¤€ ì·¨ì•½ ðŸš«: ìƒìœ„ ë””ë ‰í„°ë¦¬ì— ì´ë™ì œí•œì„ ì„¤ì •í•˜ì§€ ì•Šì€ ê²½ìš°" >> $target
echo "++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++" >> $target
echo "" >> $target
u37=0
u37_safe_check=0
u37_Service_Management=0
u37_apache_files=("/etc/apache2/conf-available/*.conf" "/etc/apache2/sites-available/*.conf" "/etc/apache2/sites-enabled/*.conf")
u37_nginx_files=("/etc/nginx/conf.d/*.conf" "/etc/nginx/sites-available/*.conf" "/etc/nginx/sites-enabled/*.conf")
u37_idx=0
u37_apache_home_checks=("httpd.conf" "apache2.conf" ".htaccess")
u37_break=0
echo "â€»Cent OS 7 ê¸°ì¤€ Apache ë©”ì¸ ì„¤ì •íŒŒì¼ ê²½ë¡œì™€ Nginx ë©”ì¸ ì„¤ì • íŒŒì¼ì¸ /etc/nginx/nginx.confë¥¼ ì ê²€í•©ë‹ˆë‹¤. í•´ë‹¹ ê²½ë¡œê°€ ì¡´ìž¬í•˜ì§€ ì•Šì„ ê²½ìš°, ì•„íŒŒì¹˜ ì›¹ ì„œë¹„ìŠ¤ êµ¬ì„± íŒŒì¼ëª…ì„ í† ëŒ€ë¡œ íŒŒì¼ íƒìƒ‰ í›„ ì ê²€ì´ ì§„í–‰ë©ë‹ˆë‹¤. ì¤‘ë³µëœ íŒŒì¼ëª…ì´ ì¡´ìž¬í•  ê²½ìš° ìˆ˜ë™ ì ê²€ì„ ê¶Œìž¥í•©ë‹ˆë‹¤.â€»"  >> $target
echo "apache, nginx ì˜ ì£¼ìš” ì„¤ì •íŒŒì¼ì„ í† ëŒ€ë¡œ apache í™ˆ ë””ë ‰í„°ë¦¬ ì ê²€ í›„ ì¶”ê°€ ì„¤ì • íŒŒì¼ ë° ë””ë ‰í„°ë¦¬ë¥¼ ì ê²€í•˜ë¯€ë¡œ, ì¤‘ë³µëœ ê²°ê³¼ê°€ ì¡´ìž¬í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤." >> $target
for u37_apache_home_check in "${u37_apache_home_checks[@]}";do
    u37_apache_home=$(find / -type f -name "$u37_apache_home_check" 2> /dev/null | egrep -v "tmp|temp|swap|swp")
    if [ -f "$u37_apache_home" ];then
        echo "$u37_apache_home íŒŒì¼ì´ ì¡´ìž¬í•©ë‹ˆë‹¤." >> $target
        u37_dir_pathconfs_a=($(grep -vE "^\s*#" "$u37_apache_home" | sed -n '/<Directory/,/<\/Directory>/p' | grep -i "^\s*AllowOverride" | awk '{print tolower($2)}'))
        u37_check_dirpath_a=($(grep -vE "^\s*#" "$u37_apache_home" | awk 'BEGIN { inBlock = 0; block = "" }/<Directory/ {block = $0;inBlock = 1;dirPath = $2; gsub("\"", "", dirPath)}/<\/Directory>/ {block = block "\n" $0;inBlock = 0;if (block ~ /AllowOverride/) { print dirPath }block = ""}inBlock && ! /<\/Directory>/ { block = block "\n" $0 }' | tr -d '>'))
        for u37_dir_pathconf_a in "${u37_dir_pathconfs_a[@]}";do
            if [ -n "$u37_dir_pathconf_a" ];then
                if [[ "$u37_dir_pathconf_a" == "none" ]];then
                    echo "AllowOverride ì§€ì‹œìžì˜ ì˜µì…˜ì´ $u37_dir_pathconf_a ë¡œ ì„¤ì •ë˜ì–´ ìƒìœ„ ë””ë ‰í† ë¦¬ë¡œì˜ ì ‘ê·¼ì„ í—ˆìš©í•˜ê³  ìžˆìŠµë‹ˆë‹¤." >> $target
                    #u37_result=$(grep -vE "^\s*#" "/etc/httpd/conf/httpd.conf" | awk 'BEGIN { IGNORECASE = 1 }/<Directory/ { block = $0; inBlock = 1 }/<\/Directory>/ { block = block "\n" $0; inBlock = 0; if (block ~ /AllowOverride\s+all/) { print block; block="" } }inBlock && !/<\/Directory>/ { block = block "\n" $0 }' | sed '1d')
                    #echo "$u37_result"
                    echo "$u37_dir_pathconf_a ë¡œ ì„¤ì •ëœ ê²½ë¡œ : ${u37_check_dirpath_a[$u37_idx]}"   >> $target
                    u37_safe_check=$((u37_safe_check+1))
                    u37_idx=$((u37_idx+1))
                elif [ "$u37_dir_pathconf_a" == "authconfig" ] || [ "$u37_dir_pathconf_a" == "all" ];then
                    echo "AllowOverride ì§€ì‹œìžì˜ ì˜µì…˜ì´ $u37_dir_pathconf_a ë¡œ ì„¤ì •ë˜ì–´ ìƒìœ„ ë””ë ‰í† ë¦¬ë¡œì˜ ì ‘ê·¼ì„ ê±°ë¶€í•˜ê³  ìžˆìŠµë‹ˆë‹¤." >> $target
                    echo "$u37_dir_pathconf_a ë¡œ ì„¤ì •ëœ ê²½ë¡œ : ${u37_check_dirpath_a[$u37_idx]}" >> $target
                    u37_idx=$((u37_idx+1))
                else
                    echo "AllowOverride ì§€ì‹œìžì˜ ì˜µì…˜ì´ $u37_dir_pathconf_a ë¡œ ì„¤ì •ë˜ì–´ ìžˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìžì™€ì˜ ìƒì˜ë°”ëžë‹ˆë‹¤." >> $target
                fi
            else
                echo "$u37_apache_home íŒŒì¼ì´ ì¡´ìž¬í•˜ì§€ë§Œ, ì„¤ì •ê°’ì´ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            fi
        done
        break
    else 
        u37_idx=0
        if [ $u37_break -eq 1 ];then
            continue
        fi
        u37_break=$((u37_break+1))
        echo "$u37_apache_home_check íŒŒì¼ì´ ì¡´ìž¬í•˜ì§€ ì•Šìœ¼ë©°, ì›¹ ì„œë¹„ìŠ¤ êµ¬ì„± íŒŒì¼ëª…ì„ í† ëŒ€ë¡œ ì ê²€ì„ ì§„í–‰í•©ë‹ˆë‹¤." >> $target
        for u37_apache_file in "${u37_apache_files[@]}";do
            for u37_apache_check in $u37_apache_file;do
                if [ -f "$u37_apache_check" ];then
                    echo "$u37_apache_check íŒŒì¼ì´ ì¡´ìž¬í•©ë‹ˆë‹¤." >> $target
                    u37_dir_pathconfs=($(grep -vE "^\s*#" "$u37_apache_check" | sed -n '/<Directory/,/<\/Directory>/p' | grep -i "^\s*AllowOverride" | awk '{print tolower($2)}'))
                    u37_check_dirpath=($(grep -vE "^\s*#" "$u37_apache_check" | awk 'BEGIN { inBlock = 0; block = "" }/<Directory/ {block = $0;inBlock = 1;dirPath = $2; gsub("\"", "", dirPath)}/<\/Directory>/ {block = block "\n" $0;inBlock = 0;if (block ~ /AllowOverride/) { print dirPath }block = ""}inBlock && ! /<\/Directory>/ { block = block "\n" $0 }' | tr -d '>'))
                    if [ ${#u37_dir_pathconfs[@]} -gt 0 ];then
                        for u37_dir_pathconf in "${u37_dir_pathconfs[@]}";do
                            if [[ "$u37_dir_pathconf" == "none" ]];then
                                echo "$u37_apache_check íŒŒì¼ì€ ì¡´ìž¬í•˜ì§€ë§Œ, AllowOverride ì§€ì‹œìžì˜ ì˜µì…˜ì´ $u37_dir_pathconf ë¡œ ì„¤ì •ë˜ì–´ ìƒìœ„ ë””ë ‰í† ë¦¬ë¡œì˜ ì ‘ê·¼ì„ í—ˆìš©í•˜ê³  ìžˆìŠµë‹ˆë‹¤." >> $target
                                #u37_result=$(grep -vE "^\s*#" "$u37_apache_check" | awk 'BEGIN { IGNORECASE = 1 }/<Directory/ { block = $0; inBlock = 1 }/<\/Directory>/ { block = block "\n" $0; inBlock = 0; if (block ~ /AllowOverride\s+all/) { print block; block="" } }inBlock && !/<\/Directory>/ { block = block "\n" $0 }' | sed '1d')
                                #echo "$u37_result"
                                echo "$u37_dir_pathconf ë¡œ ì„¤ì •ëœ ê²½ë¡œ : ${u37_check_dirpath[$u37_idx]}"   >> $target
                                u37_safe_check=$((u37_safe_check+1))
                                u37_idx=$((u37_idx+1))
                            elif [ "$u37_dir_pathconf" == "authconfig" ] || [ "$u37_dir_pathconf" == "all" ];then
                                echo "AllowOverride ì§€ì‹œìžì˜ ì˜µì…˜ì´ $u37_dir_pathconf ë¡œ ì„¤ì •ë˜ì–´ ìƒìœ„ ë””ë ‰í† ë¦¬ë¡œì˜ ì ‘ê·¼ì„ ê±°ë¶€í•˜ê³  ìžˆìŠµë‹ˆë‹¤." >> $target
                                #u37_result=$(grep -vE "^\s*#" "$u37_apache_check" | awk 'BEGIN { IGNORECASE = 1 }/<Directory/ { block = $0; inBlock = 1 }/<\/Directory>/ { block = block "\n" $0; inBlock = 0; if (block ~ /AllowOverride\s+all/) { print block; block="" } }inBlock && !/<\/Directory>/ { block = block "\n" $0 }' | sed '1d')
                                #echo "$u37_result"
                                echo "$u37_dir_pathconf ë¡œ ì„¤ì •ëœ ê²½ë¡œ : ${u37_check_dirpath[$u37_idx]}" >> $target
                                u37_idx=$((u37_idx+1))
                            else
                                echo "$u37_apache_check íŒŒì¼ì´ ì¡´ìž¬í•˜ë©°, AllowOverride ì§€ì‹œìžì˜ ì˜µì…˜ì´ $u37_dir_pathconf ë¡œ ì„¤ì •ë˜ì–´ ìžˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìžì™€ì˜ ìƒì˜ë°”ëžë‹ˆë‹¤." >> $target
                            fi
                        done
                    else
                        echo "$u37_apache_check íŒŒì¼ì€ ì¡´ìž¬í•˜ì§€ë§Œ, ê´€ë ¨ ì„¤ì •ê°’ì´ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." >> $target
                    fi
                fi
            done
        done
        echo "ì¶”ê°€ì ì¸ ì›¹ ì„œë¹„ìŠ¤ êµ¬ì„± íŒŒì¼ë“¤ì´ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì¶”ê°€ì ì¸ ìˆ˜ë™ ì ê²€ì„ ê¶Œìž¥í•©ë‹ˆë‹¤." >> $target
        u37_idx=0
    fi
done
u37_idx=0
if [ -f "/etc/nginx/nginx.conf" ];then
    echo "/etc/nginx/nginx.conf íŒŒì¼ì´ ì¡´ìž¬í•©ë‹ˆë‹¤." >> $target
    u37_dir_pathconfs_n=($(cat /etc/nginx/nginx.conf | sed -n '/location ~\* \/\\.\\. /,/}/p' | grep -i 'deny' | awk '{print $2}' | tr -d ';'))
    if [ -n "$u37_dir_pathconfs_n" ];then
        for u37_dir_pathconf_n in "${u37_dir_pathconfs_n[@]}";do
            if [[ "$u37_dir_pathconf_n" == "all" ]];then 
                echo "/etc/nginx/nginx.conf íŒŒì¼ì—ì„œ ìƒìœ„ ë””ë ‰í† ë¦¬ë¡œì˜ ì ‘ê·¼ ì œí•œ ì„¤ì • deny ê°’ì´ allë¡œ ì ì ˆí•˜ê²Œ ì„¤ì •ë˜ì–´ ìžˆìŠµë‹ˆë‹¤." >> $target
                u37_idx=$((u37_idx+1))
            else
                echo "/etc/nginx/nginx.conf íŒŒì¼ì—ì„œ ìƒìœ„ ë””ë ‰í† ë¦¬ë¡œì˜ ì ‘ê·¼ ì œí•œ ì„¤ì • deny ê°’ì´ allë¡œ ì„¤ì •ë˜ì–´ ìžˆì§€ ì•ŠìŠµë‹ˆë‹¤." >> $target
                u37_safe_check=$((u37_safe_check+1))
            fi
        done
        if [[ $u37_idx -ge 1 ]];then
            echo "/etc/nginx/nginx.conf íŒŒì¼ì—ì„œ ìƒìœ„ ë””ë ‰í† ë¦¬ë¡œì˜ ì´ë™ì´ í—ˆìš©ë˜ì–´ ìžˆìŠµë‹ˆë‹¤." >> $target
            echo "ì„¤ì • ê°’ : $u37_dir_pathconf_n" >> $target
            echo "ì´ $u37_idx ê°œì˜ ì·¨ì•½í•œ all ì„¤ì •ì´ ì¡´ìž¬í•©ë‹ˆë‹¤. /etc/nginx/nginx.conf íŒŒì¼ì„ í™•ì¸í•˜ì‹­ì‹œì˜¤." >> $target
        else
            echo "/etc/nginx/nginx.conf íŒŒì¼ì—ì„œ ìƒìœ„ ë””ë ‰í† ë¦¬ë¡œì˜ ì´ë™ì´ í—ˆìš©ë˜ì–´ ìžˆì§€ ì•ŠìŠµë‹ˆë‹¤." >> $target
        fi
    else
        echo "/etc/nginx/nginx.conf íŒŒì¼ì€ ì¡´ìž¬í•˜ì§€ë§Œ, ìƒìœ„ ë””ë ‰í† ë¦¬ì˜ ì ‘ê·¼ì„ ì œí•œí•˜ëŠ” ì„¤ì •ê°’ì´ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." >> $target
    fi
else 
    echo "/etc/nginx/nginx.conf íŒŒì¼ì´ ì¡´ìž¬í•˜ì§€ ì•Šìœ¼ë©°, ì›¹ ì„œë¹„ìŠ¤ êµ¬ì„± íŒŒì¼ëª…ì„ í† ëŒ€ë¡œ ì ê²€ì„ ì§„í–‰í•©ë‹ˆë‹¤." >> $target
    for u37_ngnix_file in "${u37_nginx_files[@]}";do
        for u37_nginx_check in $u37_ngnix_file;do 
            if [ -f "$u37_nginx_check" ];then
                echo "$u37_nginx_check íŒŒì¼ì´ ì¡´ìž¬í•©ë‹ˆë‹¤." >> $target
                u37_dir_pathconfs_n=($(cat "$u37_nginx_check" | sed -n '/location ~\* \/\\.\\. /,/}/p' | grep -i 'deny' | awk '{print $2}' | tr -d ';'))
                if [ ${#u37_dir_pathconfs_n[@]} -gt 0 ];then
                    for u37_dir_pathconf_n in "${u37_dir_pathconfs_n[@]}";do
                        if [[ "$u37_dir_pathconf_n" == "all" ]];then
                            echo "/etc/nginx/nginx.conf íŒŒì¼ì—ì„œ ìƒìœ„ ë””ë ‰í† ë¦¬ë¡œì˜ ì ‘ê·¼ ì œí•œ ì„¤ì • deny ê°’ì´ allë¡œ ì ì ˆí•˜ê²Œ ì„¤ì •ë˜ì–´ ìžˆìŠµë‹ˆë‹¤." >> $target
                            u37_idx=$((u37_idx+1))
                        else
                            echo "$u37_nginx_check íŒŒì¼ì€ ì¡´ìž¬í•˜ë‚˜, ìƒìœ„ ë””ë ‰í† ë¦¬ë¡œì˜ ì´ë™ì´ ì œí•œ ì„¤ì •ê°’ì´ deny allë¡œ ì„¤ì •ë˜ì–´ ìžˆì§€ ì•ŠìŠµë‹ˆë‹¤." >> $target
                            u37_safe_check=$((u37_safe_check+1))
                        fi
                    done
                else
                    echo echo "$u37_nginx_check íŒŒì¼ì€ ì¡´ìž¬í•˜ë‚˜, ìƒìœ„ ë””ë ‰í† ë¦¬ë¡œì˜ ì´ë™ì´ ì œí•œ ì„¤ì •ì´ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." >> $target
                fi
                if [[ $u37_idx -ge 1 ]];then
                    echo "$u37_nginx_check íŒŒì¼ì—ì„œ ìƒìœ„ ë””ë ‰í† ë¦¬ë¡œì˜ ì´ë™ì´ í—ˆìš©ë˜ì–´ ìžˆìŠµë‹ˆë‹¤." >> $target
                    echo "ì„¤ì • ê°’ : $u37_dir_pathconf_n" >> $target
                    echo "ì´ $u37_idx ê°œì˜ ì·¨ì•½í•œ all ì„¤ì •ì´ ì¡´ìž¬í•©ë‹ˆë‹¤. $u37_nginx_check íŒŒì¼ì„ í™•ì¸í•˜ì‹­ì‹œì˜¤." >> $target
                fi
            fi
        done
    done
    echo "ì¶”ê°€ì ì¸ ì›¹ ì„œë¹„ìŠ¤ êµ¬ì„± íŒŒì¼ë“¤ì´ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì¶”ê°€ì ì¸ ìˆ˜ë™ ì ê²€ì„ ê¶Œìž¥í•©ë‹ˆë‹¤." >> $target
fi

if [[ $u37_safe_check -ge 1 ]];then
    u37=$((u37+1))
    echo "ì ê²€ ê²°ê³¼ : ì·¨ì•½" >> $result
else
    echo "ì ê²€ ê²°ê³¼ : ì–‘í˜¸" >> $result
fi
if [[ $u37 -ge 1 ]];then
    High=$((High+1))
    Service_Management=$((Service_Management+1))
    u37_Service_Management=1
fi